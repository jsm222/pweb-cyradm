/*! 
 * jquery.event.drop - v 2.2
 * Copyright (c) 2010 Three Dub Media - http://threedubmedia.com
 * Open Source MIT License - http://threedubmedia.com/code/license
 */

(function(f){"function"===typeof define&&define.amd?define(["jquery","./drag"],f):f(jQuery)})(function(f){f.fn.drop=function(c,a,e){var g="string"==typeof c?c:"",d=f.isFunction(c)?c:f.isFunction(a)?a:null;0!==g.indexOf("drop")&&(g="drop"+g);e=(c==d?a:e)||{};return d?this.bind(g,e,d):this.trigger(g)};f.drop=function(c){c=c||{};a.multi=!0===c.multi?Infinity:!1===c.multi?1:isNaN(c.multi)?a.multi:c.multi;a.delay=c.delay||a.delay;a.tolerance=f.isFunction(c.tolerance)?c.tolerance:null===c.tolerance?null:
a.tolerance;a.mode=c.mode||a.mode||"intersect"};var h=f.event.special,a=f.event.special.drop={multi:1,delay:20,mode:"overlap",targets:[],datakey:"dropdata",noBubble:!0,add:function(c){f.data(this,a.datakey).related+=1},remove:function(){--f.data(this,a.datakey).related},setup:function(){f.data(this,a.datakey)||(f.data(this,a.datakey,{related:0,active:[],anyactive:0,winner:0,location:{}}),a.targets.push(this))},teardown:function(){if(!(f.data(this,a.datakey)||{}).related){f.removeData(this,a.datakey);
var c=this;a.targets=f.grep(a.targets,function(a){return a!==c})}},handler:function(c,b){var e;if(b)switch(c.type){case "mousedown":case "touchstart":e=f(a.targets);"string"==typeof b.drop&&(e=e.filter(b.drop));e.each(function(){var c=f.data(this,a.datakey);c.active=[];c.anyactive=0;c.winner=0});b.droppable=e;h.drag.hijack(c,"dropinit",b);break;case "mousemove":case "touchmove":a.event=c;a.timer||a.tolerate(b);break;case "mouseup":case "touchend":a.timer=clearTimeout(a.timer),b.propagates&&(h.drag.hijack(c,
"drop",b),h.drag.hijack(c,"dropend",b))}},locate:function(c,b){var e=f.data(c,a.datakey),g=f(c),d=g.offset()||{},h=g.outerHeight(),g=g.outerWidth(),d={elem:c,width:g,height:h,top:d.top,left:d.left,right:d.left+g,bottom:d.top+h};e&&(e.location=d,e.index=b,e.elem=c);return d},contains:function(a,b){return(b[0]||b.left)>=a.left&&(b[0]||b.right)<=a.right&&(b[1]||b.top)>=a.top&&(b[1]||b.bottom)<=a.bottom},modes:{intersect:function(a,b,e){return this.contains(e,[a.pageX,a.pageY])?1E9:this.modes.overlap.apply(this,
arguments)},overlap:function(a,b,e){return Math.max(0,Math.min(e.bottom,b.bottom)-Math.max(e.top,b.top))*Math.max(0,Math.min(e.right,b.right)-Math.max(e.left,b.left))},fit:function(a,b,e){return this.contains(e,b)?1:0},middle:function(a,b,e){return this.contains(e,[b.left+.5*b.width,b.top+.5*b.height])?1:0}},sort:function(a,b){return b.winner-a.winner||a.index-b.index},tolerate:function(c){var b,e,g,d,m,n,k=0,l,r=c.interactions.length,p=[a.event.pageX,a.event.pageY],q=a.tolerance||a.modes[a.mode];
do if(l=c.interactions[k]){if(!l)return;l.drop=[];m=[];n=l.droppable.length;q&&(g=a.locate(l.proxy));b=0;do if(e=l.droppable[b])if(d=f.data(e,a.datakey),e=d.location)d.winner=q?q.call(a,a.event,g,e):a.contains(e,p)?1:0,m.push(d);while(++b<n);m.sort(a.sort);b=0;do if(d=m[b])d.winner&&l.drop.length<a.multi?(d.active[k]||d.anyactive||(!1!==h.drag.hijack(a.event,"dropstart",c,k,d.elem)[0]?(d.active[k]=1,d.anyactive+=1):d.winner=0),d.winner&&l.drop.push(d.elem)):d.active[k]&&1==d.anyactive&&(h.drag.hijack(a.event,
"dropend",c,k,d.elem),d.active[k]=0,--d.anyactive);while(++b<n)}while(++k<r);a.last&&p[0]==a.last.pageX&&p[1]==a.last.pageY?delete a.timer:a.timer=setTimeout(function(){a.tolerate(c)},a.delay);a.last=a.event}};h.dropinit=h.dropstart=h.dropend=a});